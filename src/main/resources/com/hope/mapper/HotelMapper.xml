<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hope.mapper.HotelMapper">

    <!-- 普通分页：查询全部酒店（按ID排序） -->
    <select id="selectAllByPage" resultType="com.hope.domain.entity.Hotel">
        SELECT id,name,address,overall_rating,comment_count
        FROM hotel
        ORDER BY id ASC
            LIMIT #{offset}, #{size}
    </select>

    <!-- 普通分页：按条件、评分排序查询酒店 -->
    <select id="selectByScoreRankPage" resultType="com.hope.domain.entity.Hotel">
        SELECT id,name,city,address,price,facilities,stars,overall_rating,review_count,longitude,latitude,hi.image AS mainImage
        FROM hotel LEFT JOIN hotel_image AS hi ON hotel.id = hi.hotel_id
        <where>
            hi.sort_order = 1
            <if test="stars != null" >AND stars = #{stars}</if>
            <if test="city != null and city != ''">AND city = #{city}</if>
            <if test="minPrice != null">AND price &gt;= #{minPrice}</if>
            <if test="maxPrice != null">AND price &lt;= #{maxPrice}</if>
            <if test="facilities != null and facilities.size() > 0">
                AND (
                <foreach collection="facilities" item="facility" separator="OR">
                     FIND_IN_SET(#{facility}, facilities) > 0
                </foreach>
                )
            </if>
        </where>
        ORDER BY overall_rating DESC, id ASC
            LIMIT #{offset}, #{size}
    </select>

    <!-- 更新酒店评分和评论数 -->
    <update id="updateScoreAndCount">
        UPDATE hotel
        SET
            overall_rating = #{newAvgScore},
            comment_count = #{newCommentCount}
        WHERE hotel_id = #{hotelId}
    </update>

    <!-- 统计总条数 -->
    <select id="countTotalByCondition" resultType="java.lang.Long">
        SELECT COUNT(*) FROM hotel
        <where>
            <if test="stars != null">AND stars = #{stars}</if>
            <if test="city != null and city != ''">AND city = #{city}</if>
            <if test="minPrice != null">AND price &gt;= #{minPrice}</if>
            <if test="maxPrice != null">AND price &lt;= #{maxPrice}</if>
            <if test="facilities != null and facilities.size() > 0">
                AND (
                <foreach collection="facilities" item="facility" separator="OR">
                    FIND_IN_SET(#{facility}, facilities) > 0
                </foreach>
                )
            </if>
        </where>
    </select>

    <select id="countTotal" resultType="java.lang.Long">
        SELECT COUNT(*) FROM hotel
    </select>


    <select id="findHotelImage" resultType="java.lang.String">
        SELECT image FROM hotel_image WHERE hotel_id = #{hotelId} ORDER BY sort_order ASC
    </select>
    <select id="findHotelNameAndAddress" resultType="java.util.Map">
        SELECT name,address FROM hotel WHERE id =#{hotelId}
    </select>

</mapper>
